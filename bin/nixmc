#!/usr/bin/env python3
# This file is placed in the Public Domain.


"Nix Em Console"


import sys
import termios
import time


from nixm.main    import NAME, Client, Config, Event, forever, parse, scanner
from nixm.modules import face
from nixm.object  import Object
from nixm.runtime import Errors, later


cfg = Config()


class Console(Client):

    def callback(self, evt):
        Client.callback(self, evt)
        evt.wait()

    def poll(self):
        evt = Event()
        evt.txt = input("> ")
        return evt

    def raw(self, txt):
        print(txt)


def banner():
    tme = time.ctime(time.time()).replace("  ", " ")
    print(f"{NAME.upper()} since {tme}")


def errors():
    for error in Errors.errors:
        for line in error:
            print(line)


def opts(opts):
    for opt in opts:
        if opt in cfg.opts:
             return True
    return False


def wrap(func):
    old = None
    try:
        old = termios.tcgetattr(sys.stdin.fileno())
    except termios.error:
        pass
    try:
        func()
    except (KeyboardInterrupt, EOFError):
        print("")
    except Exception as ex:
        later(ex)
    finally:
        if old:
            termios.tcsetattr(sys.stdin.fileno(), termios.TCSADRAIN, old)


def main():
    parse(cfg, " ".join(sys.argv[1:]))
    if opts("v"):
        banner()
    for mod, thr in scanner(face, init=opts("i"), disable=cfg.sets.dis):
        if opts("v") and "output" in dir(mod):
            mod.output = print
        if thr and opts("w"):
            thr.join()
    csl = Console()
    csl.start()
    forever()


if __name__ == "__main__":
    wrap(main)
    if opts("v"):
        errors()
